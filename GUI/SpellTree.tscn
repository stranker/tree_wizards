[gd_scene load_steps=12 format=2]

[ext_resource path="res://GUI/SpellWord.tscn" type="PackedScene" id=1]
[ext_resource path="res://Assets/Sprites/Spells/ign_icon.png" type="Texture" id=2]
[ext_resource path="res://GUI/faded_circle.png" type="Texture" id=3]
[ext_resource path="res://Assets/Sprites/Spells/fa_icon.png" type="Texture" id=4]
[ext_resource path="res://UI/ControlArea.tscn" type="PackedScene" id=5]
[ext_resource path="res://Assets/Sprites/Spells/mur_icon.png" type="Texture" id=6]

[sub_resource type="GDScript" id=1]
script/source = "extends Control

export (Array, NodePath) var spell_words_path
var spell_words : Array = []
var casted_words : Array = []

export var casting : bool = false
export var screen_touched : bool = false
export var screen_drag : bool = false
var can_cast : bool = true

var current_pointer = -1

signal cast_spell(spell_list)

func _ready():
	for word_path in spell_words_path:
		var spell_word = get_node(word_path)
		spell_word.connect(\"word_pressed\", self, \"on_word_spell_pressed\")
		connect(\"cast_spell\", SpellManager, \"on_cast_spell\")
		spell_words.append(spell_word)
	pass

func _input(event):
	var pointer = extract_pointer(event)
	if event is InputEventScreenTouch:
		if !screen_drag and current_pointer != pointer and event.pressed and $ControlArea.is_inside(event.position):
			if !MultiTouch.pointer_dic.keys().has(pointer):
				MultiTouch.pointer_dic[\"Spell\"] = pointer
				current_pointer = pointer
	if current_pointer == -1:
		return
	if current_pointer == pointer:
		process_input(event)
	pass

func process_input(event):
	var touch = event is InputEventScreenTouch
	var drag = event is InputEventScreenDrag
	if touch:
		on_touch_screen(event)
	if drag:
		on_drag_screen(event)
	pass

func extract_pointer(event):
	var touch = event is InputEventScreenTouch
	var drag = event is InputEventScreenDrag
	if touch or drag:
		return event.index
	else:
		return -1

func on_touch_screen(event : InputEventScreenTouch):
	if !$ControlArea.is_inside(event.position):
		screen_touched = false
		return
	screen_touched = event.pressed
	if screen_touched:
		if !casting:
			casting = true
			$Anchor.rect_global_position = event.position
			$Anchor/Initial.on_click()
			$SpellParticles.global_position = event.position
			$SpellParticles.emitting = true
			$SpellParticles/EffectParticles.emitting = true
	else:
		screen_drag = false
		current_pointer = -1
		MultiTouch.pointer_dic.erase(\"Spell\")
		if casting:
			cast_spell()
	pass

func on_drag_screen(event : InputEventScreenDrag):
	if !$ControlArea.is_inside(event.position):
		cast_spell()
	if screen_touched:
		screen_drag = true
		$SpellParticles.global_position = event.position
		check_spell_rect(event.position)
	pass

func check_spell_rect(ev_position):
	var spell_activated = false
	for spell_word in spell_words:
		if spell_word.can_be_clicked() and !spell_activated:
			if spell_word.get_global_rect().has_point(ev_position):
				spell_word.on_click()
				spell_activated = true
	pass

func on_word_spell_pressed(spell_name):
	if casted_words.has(spell_name):
		return
	casted_words.append(spell_name)
	SpellManager.check_spell_info(casted_words)
	pass

func cast_spell():
	if !casted_words.empty():
		emit_signal(\"cast_spell\", casted_words.duplicate())
		can_cast = false
	casting = false
	screen_drag = false
	$SpellParticles.emitting = false
	$SpellParticles/EffectParticles.emitting = false
	reset_words()
	pass

func reset_words():
	for word in spell_words:
		word.reset()
	casted_words.clear()
	pass

func _on_Wizard_learn_spell(spell_name : String):
	for spell in spell_words:
		if spell.spell_name.to_lower() == spell_name.to_lower():
			spell.learn()
			return
	pass # Replace with function body.

func _on_SpellManager_cast_ready():
	can_cast = true
	pass # Replace with function body.
"

[sub_resource type="Curve" id=2]
_data = [ Vector2( 0.00892857, 1 ), 0.0, -1.72782, 0, 0, Vector2( 1, 0.245455 ), -0.0581817, 0.0, 0, 0 ]

[sub_resource type="Gradient" id=3]
offsets = PoolRealArray( 0.00497512, 0.985075 )
colors = PoolColorArray( 0.592157, 0.168627, 0.858824, 1, 0.478431, 0.054902, 0.745098, 0 )

[sub_resource type="Curve" id=4]
_data = [ Vector2( 0.0133929, 1 ), 0.0, -1.97647, 0, 0, Vector2( 1, 0.218182 ), -0.476596, 0.0, 0, 0 ]

[sub_resource type="Gradient" id=5]
offsets = PoolRealArray( 0, 0.164179, 0.502488, 0.761194 )
colors = PoolColorArray( 0.835294, 0.568627, 1, 0.280899, 0.72549, 0.443137, 0.898039, 0.756863, 0.72549, 0.443137, 0.898039, 0.709804, 0.835294, 0.568627, 1, 0 )

[node name="SpellTree" type="Control"]
anchor_right = 1.0
anchor_bottom = 1.0
mouse_filter = 1
script = SubResource( 1 )
__meta__ = {
"_edit_use_anchors_": false
}
spell_words_path = [ NodePath("Anchor/Initial"), NodePath("Anchor/Ign"), NodePath("Anchor/Fa"), NodePath("Anchor/Zur"), NodePath("Anchor/Dor") ]

[node name="ControlArea" parent="." instance=ExtResource( 5 )]
modulate = Color( 1, 1, 1, 0 )

[node name="Anchor" type="Control" parent="."]
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
margin_left = 478.742
margin_top = 73.437
margin_right = 518.742
margin_bottom = 113.437
mouse_filter = 2
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Initial" parent="Anchor" instance=ExtResource( 1 )]
visible = false
margin_left = -78.5
margin_top = -52.3852
margin_right = 54.5
margin_bottom = 80.6148
next_words = [ NodePath("../Ign"), NodePath("../Fa") ]
learned = true

[node name="Ign" parent="Anchor" instance=ExtResource( 1 )]
visible = false
margin_left = -265.729
margin_top = -180.385
margin_right = -137.729
margin_bottom = -52.3852
spell_name = "Ign"
next_words = [ NodePath("../Zur"), NodePath("../Dor") ]
learned = true
spell_texture = ExtResource( 2 )

[node name="Fa" parent="Anchor" instance=ExtResource( 1 )]
visible = false
margin_left = -40.0
margin_top = -239.819
margin_right = 88.0
margin_bottom = -111.819
spell_name = "Fa"
next_words = [ NodePath("../Zur"), NodePath("../Dor") ]
learned = true
spell_texture = ExtResource( 4 )

[node name="Zur" parent="Anchor" instance=ExtResource( 1 )]
visible = false
margin_left = -304.229
margin_top = -386.632
margin_right = -176.229
margin_bottom = -258.632
spell_name = "Zur"
learned = true
spell_texture = ExtResource( 6 )

[node name="Dor" parent="Anchor" instance=ExtResource( 1 )]
visible = false
margin_left = -55.0049
margin_top = -425.132
margin_right = 72.9951
margin_bottom = -297.132
spell_name = "Dor"
learned = true
spell_texture = ExtResource( 6 )

[node name="SpellParticles" type="CPUParticles2D" parent="."]
position = Vector2( 1338.59, 613.437 )
emitting = false
amount = 25
lifetime = 0.5
explosiveness = 0.1
local_coords = false
texture = ExtResource( 3 )
emission_shape = 1
emission_sphere_radius = 10.0
spread = 180.0
gravity = Vector2( 0, 0 )
initial_velocity = 200.0
initial_velocity_random = 1.0
angle = 360.0
angle_random = 1.0
scale_amount = 0.15
scale_amount_random = 0.15
scale_amount_curve = SubResource( 2 )
color_ramp = SubResource( 3 )

[node name="EffectParticles" type="CPUParticles2D" parent="SpellParticles"]
emitting = false
amount = 25
lifetime = 0.5
explosiveness = 0.1
local_coords = false
texture = ExtResource( 3 )
emission_shape = 1
emission_sphere_radius = 1.0
spread = 180.0
gravity = Vector2( 0, 0 )
initial_velocity = 50.0
initial_velocity_random = 1.0
orbit_velocity_random = 1.0
tangential_accel_random = 1.0
angle = 360.0
angle_random = 1.0
scale_amount = 0.12
scale_amount_random = 0.1
scale_amount_curve = SubResource( 4 )
color_ramp = SubResource( 5 )
